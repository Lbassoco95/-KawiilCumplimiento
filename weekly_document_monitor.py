#!/usr/bin/env python3
"""
Sistema de Seguimiento Semanal de Documentos
Detecta documentos nuevos y modificados autom√°ticamente
"""

import os
import schedule
import time
import logging
from datetime import datetime, timedelta
from typing import Dict, List, Set
from dotenv import load_dotenv
from initial_document_analysis import InitialDocumentAnalyzer
from metadata_enricher import generate_folder_report

# Configurar logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('weekly_monitor.log'),
        logging.StreamHandler()
    ]
)
logger = logging.getLogger(__name__)

class WeeklyDocumentMonitor:
    """Sistema de seguimiento semanal de documentos"""
    
    def __init__(self):
        load_dotenv()
        self.analyzer = InitialDocumentAnalyzer()
        self.monitoring_active = False
        
    def weekly_analysis(self):
        """An√°lisis semanal autom√°tico"""
        logger.info("üìÖ INICIANDO AN√ÅLISIS SEMANAL AUTOM√ÅTICO")
        logger.info("=" * 50)
        
        try:
            # Ejecutar an√°lisis incremental
            self.analyzer.run_initial_analysis(force_full=False)
            
            # Generar reporte semanal
            self.generate_weekly_report()
            
            logger.info("‚úÖ An√°lisis semanal completado")
            
        except Exception as e:
            logger.error(f"‚ùå Error en an√°lisis semanal: {e}")
    
    def generate_weekly_report(self):
        """Generar reporte semanal"""
        try:
            # Obtener estad√≠sticas del √≠ndice Pinecone
            stats = self.analyzer.index.describe_index_stats()
            total_vectors = stats.total_vector_count
            
            # Contar vectores con metadatos enriquecidos
            enriched_count = 0
            try:
                query_response = self.analyzer.index.query(
                    vector=[0] * 1536,
                    top_k=1000,
                    include_metadata=True,
                    filter={"metadata_enriquecido": {"$eq": True}}
                )
                enriched_count = len(query_response.matches)
            except:
                enriched_count = "N/A"
            
            # Generar reporte
            report = f"""
üìä REPORTE SEMANAL DE MONITOREO DE DOCUMENTOS
==============================================
Fecha: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
Per√≠odo: √öltima semana

üìà ESTAD√çSTICAS DE LA BASE DE DATOS:
‚Ä¢ Total de vectores en Pinecone: {total_vectors:,}
‚Ä¢ Vectores con metadatos enriquecidos: {enriched_count}
‚Ä¢ Archivos analizados esta semana: {self.analyzer.analysis_status.get('processed_files', 0)}
‚Ä¢ Archivos fallidos: {len(self.analyzer.analysis_status.get('failed_files', []))}

üìÅ ACTIVIDAD DE DOCUMENTOS:
‚Ä¢ Nuevos archivos detectados: {self.count_new_files()}
‚Ä¢ Archivos modificados: {self.count_modified_files()}
‚Ä¢ Archivos sin cambios: {self.count_unchanged_files()}

üîç ESTADO DEL SISTEMA:
‚Ä¢ Monitoreo semanal: ‚úÖ ACTIVO
‚Ä¢ Enriquecimiento de metadatos: ‚úÖ FUNCIONANDO
‚Ä¢ Conexi√≥n con Google Drive: ‚úÖ ESTABLE
‚Ä¢ Conexi√≥n con Pinecone: ‚úÖ ESTABLE
‚Ä¢ Conexi√≥n con OpenAI: ‚úÖ ESTABLE

üìã PR√ìXIMAS ACCIONES:
‚Ä¢ Pr√≥ximo an√°lisis autom√°tico: {datetime.now() + timedelta(days=7)}
‚Ä¢ Verificaci√≥n de logs: tail -f weekly_monitor.log
‚Ä¢ Estado en Slack: /estado

üéØ RECOMENDACIONES:
‚Ä¢ Revisar archivos fallidos si los hay
‚Ä¢ Verificar m√©tricas de enriquecimiento
‚Ä¢ Probar b√∫squedas en Slack
"""
            
            # Guardar reporte
            timestamp = datetime.now().strftime("%Y%m%d")
            report_filename = f"reporte_semanal_{timestamp}.txt"
            
            with open(report_filename, 'w', encoding='utf-8') as f:
                f.write(report)
            
            logger.info(f"üìÑ Reporte semanal guardado: {report_filename}")
            
            # Tambi√©n guardar en formato JSON para an√°lisis posterior
            json_report = {
                "fecha": datetime.now().isoformat(),
                "total_vectores": total_vectors,
                "vectores_enriquecidos": enriched_count,
                "archivos_procesados": self.analyzer.analysis_status.get('processed_files', 0),
                "archivos_fallidos": len(self.analyzer.analysis_status.get('failed_files', [])),
                "nuevos_archivos": self.count_new_files(),
                "archivos_modificados": self.count_modified_files(),
                "archivos_sin_cambios": self.count_unchanged_files()
            }
            
            json_filename = f"reporte_semanal_{timestamp}.json"
            import json
            with open(json_filename, 'w', encoding='utf-8') as f:
                json.dump(json_report, f, indent=2, ensure_ascii=False)
            
            return report
            
        except Exception as e:
            logger.error(f"Error generando reporte semanal: {e}")
            return f"Error generando reporte: {e}"
    
    def count_new_files(self) -> int:
        """Contar archivos nuevos"""
        count = 0
        for file_info in self.analyzer.analysis_status.get("analyzed_files", {}).values():
            if file_info.get("reason") == "new":
                count += 1
        return count
    
    def count_modified_files(self) -> int:
        """Contar archivos modificados"""
        count = 0
        for file_info in self.analyzer.analysis_status.get("analyzed_files", {}).values():
            if file_info.get("reason") == "modified":
                count += 1
        return count
    
    def count_unchanged_files(self) -> int:
        """Contar archivos sin cambios"""
        count = 0
        for file_info in self.analyzer.analysis_status.get("analyzed_files", {}).values():
            if file_info.get("reason") == "no_changes":
                count += 1
        return count
    
    def start_monitoring(self):
        """Iniciar monitoreo semanal"""
        logger.info("üöÄ Iniciando monitoreo semanal de documentos")
        
        # Programar an√°lisis semanal (viernes a las 02:00)
        schedule.every().friday.at("02:00").do(self.weekly_analysis)
        
        # Tambi√©n programar verificaci√≥n diaria de estado
        schedule.every().day.at("09:00").do(self.daily_status_check)
        
        self.monitoring_active = True
        
        logger.info("‚úÖ Monitoreo programado:")
        logger.info("   üìÖ An√°lisis semanal: Viernes 02:00")
        logger.info("   üìä Verificaci√≥n diaria: 09:00")
        
        # Ejecutar an√°lisis inicial si es la primera vez
        if not self.analyzer.analysis_status.get("last_analysis"):
            logger.info("üîÑ Primera ejecuci√≥n - Iniciando an√°lisis inicial...")
            self.analyzer.run_initial_analysis(force_full=True)
        
        # Mantener el monitoreo activo
        while self.monitoring_active:
            try:
                schedule.run_pending()
                time.sleep(60)  # Verificar cada minuto
            except KeyboardInterrupt:
                logger.info("üõë Monitoreo detenido por el usuario")
                break
            except Exception as e:
                logger.error(f"Error en monitoreo: {e}")
                time.sleep(300)  # Esperar 5 minutos antes de reintentar
    
    def stop_monitoring(self):
        """Detener monitoreo"""
        self.monitoring_active = False
        logger.info("üõë Monitoreo detenido")
    
    def daily_status_check(self):
        """Verificaci√≥n diaria de estado"""
        logger.info("üìä Verificaci√≥n diaria de estado del sistema")
        
        try:
            # Verificar conexiones
            connections_ok = True
            
            # Verificar Pinecone
            try:
                stats = self.analyzer.index.describe_index_stats()
                logger.info(f"‚úÖ Pinecone: {stats.total_vector_count} vectores")
            except Exception as e:
                logger.error(f"‚ùå Error Pinecone: {e}")
                connections_ok = False
            
            # Verificar Dropbox
            try:
                self.analyzer.dbx.files_list_folder("/", limit=1)
                logger.info("‚úÖ Dropbox: Conectado")
            except Exception as e:
                logger.error(f"‚ùå Error Dropbox: {e}")
                connections_ok = False
            
            # Verificar OpenAI
            try:
                from openai import OpenAI
                client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
                response = client.chat.completions.create(
                    model="gpt-4o",
                    messages=[{"role": "user", "content": "test"}],
                    max_tokens=5
                )
                logger.info("‚úÖ OpenAI: Conectado")
            except Exception as e:
                logger.error(f"‚ùå Error OpenAI: {e}")
                connections_ok = False
            
            if connections_ok:
                logger.info("üéâ Todas las conexiones funcionando correctamente")
            else:
                logger.warning("‚ö†Ô∏è Algunas conexiones tienen problemas")
            
        except Exception as e:
            logger.error(f"Error en verificaci√≥n diaria: {e}")
    
    def manual_weekly_analysis(self):
        """Ejecutar an√°lisis semanal manualmente"""
        logger.info("üîÑ Ejecutando an√°lisis semanal manual...")
        self.weekly_analysis()

def main():
    """Funci√≥n principal"""
    print("üìÖ Sistema de Seguimiento Semanal de Documentos")
    print("=" * 50)
    
    monitor = WeeklyDocumentMonitor()
    
    print("\nüìã Opciones disponibles:")
    print("1. Iniciar monitoreo semanal autom√°tico")
    print("2. Ejecutar an√°lisis semanal manual")
    print("3. Verificar estado del sistema")
    print("4. Generar reporte semanal")
    print("5. An√°lisis inicial completo")
    
    try:
        option = input("\nSelecciona una opci√≥n (1-5): ").strip()
        
        if option == "1":
            print("\nüöÄ Iniciando monitoreo semanal autom√°tico...")
            print("üìÖ An√°lisis programado: Viernes 02:00")
            print("üìä Verificaci√≥n diaria: 09:00")
            print("‚è∞ Presiona Ctrl+C para detener")
            
            monitor.start_monitoring()
        
        elif option == "2":
            print("\nüîÑ Ejecutando an√°lisis semanal manual...")
            monitor.manual_weekly_analysis()
        
        elif option == "3":
            print("\nüìä Verificando estado del sistema...")
            monitor.daily_status_check()
        
        elif option == "4":
            print("\nüìÑ Generando reporte semanal...")
            report = monitor.generate_weekly_report()
            print(report)
        
        elif option == "5":
            print("\nüîç Ejecutando an√°lisis inicial completo...")
            monitor.analyzer.run_initial_analysis(force_full=True)
        
        else:
            print("‚ùå Opci√≥n no v√°lida")
    
    except KeyboardInterrupt:
        print("\n‚ùå Operaci√≥n cancelada por el usuario")
    except Exception as e:
        print(f"‚ùå Error: {e}")

if __name__ == "__main__":
    main() 